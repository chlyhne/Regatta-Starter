#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "Usage: $0 <file.ndjson|file.ndjson.gz>" >&2
}

if [ $# -lt 1 ]; then
  usage
  exit 1
fi

src="$1"
if [ ! -f "$src" ]; then
  echo "File not found: $src" >&2
  exit 1
fi

dest_dir="replay"
mkdir -p "$dest_dir"
base="$(basename "$src")"
dest="$dest_dir/$base"

if [ "$src" != "$dest" ]; then
  if [ -e "$dest" ]; then
    if cmp -s "$src" "$dest"; then
      echo "Replay file already exists: $dest (same contents)." >&2
    else
      echo "Replay file already exists: $dest (different contents)." >&2
      exit 1
    fi
  else
    cp "$src" "$dest"
  fi
fi

python3 - "$base" <<'PY'
import json
import os
import re
import sys

manifest_path = os.path.join("replay", "manifest.json")
data = []
if os.path.exists(manifest_path):
    with open(manifest_path, "r", encoding="utf-8") as handle:
        try:
            data = json.load(handle)
        except json.JSONDecodeError as exc:
            raise SystemExit(f"Invalid JSON in {manifest_path}: {exc}") from exc

if not isinstance(data, list):
    raise SystemExit(f"{manifest_path} must contain a JSON array.")

file_name = os.path.basename(sys.argv[1]) if len(sys.argv) > 1 else ""
if not file_name:
    raise SystemExit("Missing replay file name")

if any(isinstance(entry, dict) and entry.get("path") == file_name for entry in data):
    print(f"Manifest already contains {file_name}")
    sys.exit(0)

label = os.path.splitext(file_name)[0]
slug = re.sub(r"[^a-z0-9]+", "-", label.lower()).strip("-")
if not slug:
    slug = "replay"
existing = {entry.get("id") for entry in data if isinstance(entry, dict)}
candidate = slug
suffix = 2
while candidate in existing:
    candidate = f"{slug}-{suffix}"
    suffix += 1

entry = {"id": candidate, "label": label, "path": file_name}
data.append(entry)

with open(manifest_path, "w", encoding="utf-8") as handle:
    json.dump(data, handle, indent=2)
    handle.write("\n")
PY

REPLAY_FILE="$base" python3 - <<'PY'
import os
import re

sw_path = "sw.js"
with open(sw_path, "r", encoding="utf-8") as handle:
    text = handle.read()

match = re.search(r'const\s+CACHE_NAME\s*=\s*"racetimer-v(\d+)"', text)
if not match:
    raise SystemExit("CACHE_NAME not found in sw.js")
current = int(match.group(1))
text = re.sub(
    r'const\s+CACHE_NAME\s*=\s*"racetimer-v\d+"',
    f'const CACHE_NAME = "racetimer-v{current + 1}"',
    text,
    count=1,
)

file_name = os.path.basename(os.environ.get("REPLAY_FILE", ""))
if not file_name:
    raise SystemExit("Missing REPLAY_FILE")

asset_line = f'  "./replay/{file_name}",'
if asset_line not in text:
    start = text.find("const ASSETS = [")
    if start < 0:
        raise SystemExit("ASSETS array not found in sw.js")
    end = text.find("];", start)
    if end < 0:
        raise SystemExit("ASSETS array closing not found in sw.js")
    text = text[:end] + asset_line + "\n" + text[end:]

with open(sw_path, "w", encoding="utf-8") as handle:
    handle.write(text)
PY

echo "Added replay file: $dest"
echo "Updated replay/manifest.json and sw.js"
