% !TeX root = master.tex

\section{VMG Hunter (RaceVMG)}

VMG Hunter works without a wind sensor. We start with the upwind case and assume the
boat is sailing in a narrow range of true wind angles (TWA), roughly \(35^\circ\) to
\(50^\circ\). The user selects an approximate TWA, and the app estimates whether a small
change in heading should be a \emph{bear away} or a \emph{head up}.

\subsection{Speed--heading trade-off}

This subsection derives a break-even slope that converts speed changes into an equivalent
heading change at the selected TWA, giving a left/right steering decision rule.

For a given TWA \(\psi\), the upwind velocity made good is:
\[
\mathrm{VMG}(\psi) = v(\psi)\cos\psi
\]

For a small change \(d\psi\), the first-order change is:
\[
\frac{d}{d\psi}\mathrm{VMG} =
\frac{dv}{d\psi}\cos\psi - v\sin\psi
\]

At the break-even point (no VMG gain or loss), this derivative is zero:
\[
\frac{dv}{d\psi} = v\tan\psi
\]

This is the trade-off slope between speed and heading. We estimate
\(\frac{dv}{d\psi}\) from recent data and compare it to the break-even slope. If the
estimated slope is greater than the break-even slope, bearing away is faster; if it is
smaller, heading up is faster.

Because our heading samples are handled in degrees in the UI and estimator, the
comparison uses:
\[
\frac{dv}{d(\mathrm{deg})} = v\tan\psi \cdot \frac{\pi}{180}
\]

\subsection{Estimating the slope (RLS with forgetting)}

In the app we do not try to build a full polar model. Instead, we estimate the \emph{local}
slope in the neighborhood of the current trim and sea state. That is precisely what we
need to decide whether a small heading change is paying off. We use recursive least
squares (RLS) with exponential forgetting so the estimator behaves like an IIR filter: it
reacts to new information, but it does not jump around when the boat is steady.

Concretely, we feed the estimator a speed measurement (GPS speed for now, later optionally
Kalman-filtered speed) and a heading estimate. Because heading wraps at \(360^\circ\), we
unwrap it so small real changes do not appear as huge jumps. The forgetting is controlled
by a time constant \(\tau \approx 10\,\mathrm{s}\), which sets the effective memory of the
fit: shorter \(\tau\) reacts faster but is noisier; longer \(\tau\) is steadier but slower.

Heading source. When IMU is enabled, we integrate the gyro yaw rate to track heading
changes and use that heading in the regressor. GPS course is used to correct long-term
drift only when speed exceeds \(2\,\mathrm{kn}\) and GPS accuracy is acceptable. If IMU is
disabled, or no IMU heading is available yet, we fall back to GPS heading.

Let \(h_k\) be heading (degrees) and \(v_k\) speed (m/s) at sample \(k\). We use unwrapped
heading relative to a fixed reference so the regressor stays small:
\(h_k = \psi_k - \psi_0\). This shift does not change the slope.

We fit a line \(v_k = b_k + s_k h_k + e_k\), written in vector form:
\[
v_k = x_k^T \theta_k + e_k,\quad
x_k = \begin{bmatrix} 1 \\ h_k \end{bmatrix},\quad
\theta_k = \begin{bmatrix} b_k \\ s_k \end{bmatrix}
\]

With forgetting factor \(\lambda_k = e^{-\Delta t_k/\tau}\), the RLS recursion is:
\[
K_k = \frac{P_{k-1} x_k}{\lambda_k + x_k^T P_{k-1} x_k}
\]
\[
\theta_k = \theta_{k-1} + K_k \left(v_k - x_k^T \theta_{k-1}\right)
\]
\[
P_k = \frac{1}{\lambda_k}\left(P_{k-1} - K_k x_k^T P_{k-1}\right)
\]
where the residual is \(e_k = v_k - x_k^T \theta_{k-1}\).

The slope estimate at sample \(k\) is the second component:
\[
s_k = \theta_{k,2}
\]
when the heading excitation is large enough to be reliable.

\subsection{Confidence band and tack handling}

This subsection explains how estimator uncertainty becomes the UI confidence band, and how
port/starboard tack flips the meaning of left/right.

We compute a simple standard error for the slope:
\[
\sigma_{s,k} \approx \sqrt{\sigma_{e,k}^2 \, P_{k,22}}
\]
where \(\sigma_{e,k}^2\) is an exponentially weighted residual variance, for example:
\[
\sigma_{e,k}^2 = (1-\alpha_k)\sigma_{e,k-1}^2 + \alpha_k e_k^2,\quad
\alpha_k = 1 - e^{-\Delta t_k/\tau}
\]
The UI maps \(\sigma_{s,k}\) to a confidence band width. If GPS is stale or accuracy is
poor, the bar is desaturated to signal low trust.

Tack handling. The indicator is directional: on port tack the left/right meaning flips.
We implement this by negating the slope before comparing to the break-even value and
swapping the labels accordingly.
