#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "Usage: $0 <file.ndjson|file.ndjson.gz|id|--all>" >&2
}

if [ $# -lt 1 ]; then
  usage
  exit 1
fi

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$script_dir"

input="$1"
manifest_path="replay/manifest.json"

if [ "$input" = "--all" ] || [ "$input" = "all" ]; then
  if [ -f "$manifest_path" ]; then
    git rm -f --quiet "$manifest_path" 2>/dev/null || rm -f "$manifest_path"
  fi

  if [ -d "replay" ]; then
    find replay -maxdepth 1 -type f ! -name "manifest.json" -print0 | while IFS= read -r -d '' file; do
      git rm -f --quiet "$file" 2>/dev/null || rm -f "$file"
    done
  fi
  mkdir -p replay
  echo "Removed all replay entries."
  exit 0
fi

if [ ! -f "$manifest_path" ]; then
  echo "Manifest not found: $manifest_path" >&2
  exit 1
fi

info="$(python3 - "$input" "$manifest_path" <<'PY'
import json
import os
import sys

raw_input = sys.argv[1]
manifest_path = sys.argv[2]

with open(manifest_path, "r", encoding="utf-8") as handle:
    try:
        data = json.load(handle)
    except json.JSONDecodeError as exc:
        raise SystemExit(f"Invalid JSON in {manifest_path}: {exc}") from exc

if not isinstance(data, list):
    raise SystemExit(f"{manifest_path} must contain a JSON array.")

def normalize(value):
    return str(value or "").strip()

input_value = normalize(raw_input)
input_base = os.path.basename(input_value)
if input_base.startswith("replay" + os.sep):
    input_base = os.path.basename(input_base)

match_index = None
removed_files = None
for idx, entry in enumerate(data):
    if not isinstance(entry, dict):
        continue
    entry_id = normalize(entry.get("id"))
    entry_path = normalize(entry.get("path"))
    entry_base = os.path.basename(entry_path)
    if input_value in {entry_id, entry_path, entry_base, os.path.basename(entry_id)}:
        match_index = idx
        if isinstance(entry.get("chunks"), list) and entry.get("chunks"):
            removed_files = entry.get("chunks")
        else:
            removed_files = [entry_path]
        break
    if input_base and input_base in {entry_path, entry_base}:
        match_index = idx
        if isinstance(entry.get("chunks"), list) and entry.get("chunks"):
            removed_files = entry.get("chunks")
        else:
            removed_files = [entry_path]
        break

if match_index is None or not removed_files:
    raise SystemExit(f"Replay entry not found for: {raw_input}")

data.pop(match_index)

if data:
    with open(manifest_path, "w", encoding="utf-8") as handle:
        json.dump(data, handle, indent=2)
        handle.write("\n")
    state = "KEEP"
else:
    os.remove(manifest_path)
    state = "EMPTY"

print(json.dumps({"files": removed_files, "manifest_state": state}))
PY
)"

if [ -z "$info" ]; then
  echo "Could not resolve replay files from manifest." >&2
  exit 1
fi

REPLAY_INFO="$info" python3 - <<'PY'
import json
import os
import subprocess

info = json.loads(os.environ.get("REPLAY_INFO", "{}"))
files = info.get("files") or []
manifest_state = info.get("manifest_state") or ""

if not files:
    raise SystemExit("Missing replay files list.")

for name in files:
    candidate = name
    if os.path.exists(os.path.join("replay", name)):
        candidate = os.path.join("replay", name)
    if os.path.exists(candidate):
        subprocess.run(["git", "rm", "-f", "--quiet", candidate], check=False)
        if os.path.exists(candidate):
            os.remove(candidate)

if manifest_state == "EMPTY":
    if os.path.exists("replay/manifest.json"):
        subprocess.run(["git", "rm", "-f", "--quiet", "replay/manifest.json"], check=False)
        if os.path.exists("replay/manifest.json"):
            os.remove("replay/manifest.json")
PY

mkdir -p replay
if REPLAY_INFO="$info" python3 - <<'PY'
import json, os, sys
info = json.loads(os.environ.get("REPLAY_INFO", "{}"))
sys.exit(0 if info.get("manifest_state") == "KEEP" else 1)
PY
then
  if [ -f "$manifest_path" ]; then
    git add "$manifest_path" >/dev/null 2>&1 || true
  fi
fi

echo "Removed replay entry:"
REPLAY_INFO="$info" python3 - <<'PY'
import json
info = json.loads(os.environ.get("REPLAY_INFO", "{}"))
for name in info.get("files") or []:
    print(f"  {name}")
PY
